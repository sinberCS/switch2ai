# Switch2AI 新功能设计说明

## 功能概述

基于原有的复杂多模式配置系统，我们重构了一个更简洁、更直观的操作模式，将原有功能简化为两种主要操作类型：

1. **跳转命令**: 固定的4个AI编辑器跳转功能
2. **提示词命令**: 灵活的AI提示词输入和执行系统

## 新功能特性

### 🎯 简化操作模式
- **从复杂到简单**: 从多种AI模式配置简化为两种固定操作类型
- **智能默认配置**: 预设常用的跳转命令和快捷命令
- **灵活自定义**: 支持用户完全自定义命令和快捷键

### 💬 提示词系统
- **即时输入**: Alt+Shift+P 快速打开提示词输入弹窗
- **AI模式切换**: 在弹窗中动态选择目标AI (Cursor, Qoder, Claude Code)
- **快捷命令**: 支持 $test, $refactor, $explain 等快捷命令自动替换
- **上下文感知**: 自动传递当前文件路径、行号、列号等上下文信息

### 🔧 自定义命令系统
- **统一管理**: 跳转命令和自定义命令统一在一个配置界面管理
- **变量支持**: 支持 ${filePath}, ${projectPath}, ${line}, ${column} 等变量
- **灵活编辑**: 所有命令（包括默认跳转命令）都可以修改、删除
- **分类管理**: 通过类别区分不同类型的命令

## 核心组件

### 1. 新配置模型 (NewConfigModel.kt)
```kotlin
// AI配置
data class AIConfig(
    val name: String,           // AI标识符
    val displayName: String,    // 显示名称  
    val command: String,        // 命令模板
    val enabled: Boolean,       // 是否启用
    val isDefault: Boolean      // 是否为默认AI
)

// 自定义命令
data class CustomCommand(
    val id: String,             // 唯一标识
    val name: String,           // 命令名称
    val shortcut: String,       // 快捷键
    val command: String,        // 命令模板
    val category: CommandCategory // 命令分类
)
```

### 2. 提示词输入弹窗 (PromptInputDialog.kt)
- 智能布局设计，显示当前文件信息
- AI选择下拉框，支持动态切换
- 多行提示词输入，支持 Enter 确认、Esc 取消
- 快捷命令提示，帮助用户快速输入

### 3. 快捷命令替换器 (ShortcutCommandReplacer.kt)
- 自动识别和替换快捷命令
- 支持自定义快捷命令映射
- 智能文本处理，保持原有内容结构

### 4. 新命令处理器 (NewCommandProcessor.kt)
- 统一的命令执行引擎
- 支持自定义命令和提示词命令
- 在IDE终端中执行，提供完整的执行环境

## 默认配置

### 跳转命令
| 命令 | 快捷键 | 功能 |
|------|--------|------|
| 跳转文件到Cursor | Alt+Shift+1 | 在Cursor中打开当前文件并定位 |
| 跳转项目到Cursor | Alt+Shift+2 | 在Cursor中打开当前项目 |
| 跳转文件到Qoder | Alt+Shift+3 | 在Qoder中打开当前文件并定位 |
| 跳转项目到Qoder | Alt+Shift+4 | 在Qoder中打开当前项目 |

### AI配置
- **Cursor AI**: 默认启用，支持提示词命令
- **Qoder AI**: 默认启用，支持提示词命令  
- **Claude Code**: 默认启用，支持提示词命令

### 快捷命令
| 快捷命令 | 替换内容 |
|----------|----------|
| $test | 请为这个函数编写单元测试，确保覆盖边界条件和异常情况 |
| $refactor | 请重构这段代码，提高可读性和性能，保持原有功能不变 |
| $explain | 请详细解释这段代码的功能和实现原理 |
| $optimize | 请优化这段代码的性能和内存使用 |
| $debug | 请帮我分析这段代码可能存在的bug和问题 |
| $doc | 请为这段代码生成详细的文档注释 |

## 使用方法

### 快速跳转
1. 在代码编辑器中定位到想要的位置
2. 使用快捷键快速跳转:
   - `Alt+Shift+1`: 跳转到Cursor
   - `Alt+Shift+3`: 跳转到Qoder

## 🆕 最新功能更新

### 光标边上的小弹框功能

#### 功能概述
原来的提示词输入弹窗（Alt+Shift+K）已经从大型对话框改为在光标位置显示的小弹窗，提供更好的用户体验。

#### 主要改进

##### 1. 弹窗尺寸优化
- **原来**: 600x400 像素的大型对话框
- **现在**: 400x300 像素的紧凑弹窗
- **优势**: 不会遮挡代码内容，更专注于输入

##### 2. 弹窗定位优化
- **原来**: 屏幕中央的模态对话框
- **现在**: 在光标位置附近显示的非模态弹窗
- **优势**: 弹窗跟随光标位置，操作更直观

##### 3. 交互体验提升
- **快捷键支持**: 
  - `Ctrl+Enter`: 执行命令
  - `Esc`: 取消操作
- **非模态设计**: 弹窗不会阻塞其他操作
- **自动定位**: 弹窗自动选择最佳显示位置

#### 技术实现

##### 核心组件
- **PromptInputPopup**: 新的小弹窗组件
- **JBPopupFactory**: IDEA 的弹窗工厂
- **Editor 集成**: 与编辑器光标位置集成

##### 关键特性
- 继承自 IDEA 的 `JBPopup` 系统
- 支持键盘导航和快捷键
- 自动处理弹窗定位和显示
- 保持所有原有功能（AI选择、提示词输入、快捷命令帮助）

#### 使用方法

##### 触发方式
1. 使用快捷键 `Alt+Shift+K`
2. 右键菜单选择 "AI提示词输入"

##### 操作流程
1. 弹窗在光标位置显示
2. 选择 AI 模式
3. 输入提示词
4. 使用 `Ctrl+Enter` 执行或点击"执行"按钮
5. 使用 `Esc` 取消操作

#### 兼容性
- 完全兼容现有的配置系统
- 保持所有原有功能
- 不影响其他快捷键和命令

#### 未来优化方向
- 支持弹窗拖拽定位
- 添加更多快捷键选项
- 优化弹窗样式和主题
- 支持弹窗大小记忆功能

### 提示词交互
1. 按 `Alt+Shift+P` 打开提示词输入弹窗
2. (可选) 切换AI模式
3. 输入提示词，可以使用快捷命令如 `$test getCurrentUser方法`
4. 按 Enter 执行，或 Esc 取消

### 自定义配置
1. 打开 Settings → Tools → Switch2AI (新版)
2. 在"AI配置"选项卡中管理AI设置
3. 在"自定义命令"选项卡中添加或修改命令
4. 在"快捷命令"选项卡中定义快捷命令映射

## 技术架构

### 分层设计
```
用户交互层 → 业务逻辑层 → 执行引擎层 → 数据持久化层
```

### 核心模式
- **单一职责**: 每个组件都有明确的职责边界
- **配置驱动**: 通过配置文件动态控制功能行为
- **事件驱动**: 基于IntelliJ平台的事件机制
- **插件架构**: 可扩展的插件化设计

## 兼容性说明

- **向后兼容**: 新系统与旧系统并存，不影响现有配置
- **平滑迁移**: 用户可以逐步从旧系统迁移到新系统
- **功能对比**: 通过两套配置界面可以对比功能差异

## 未来扩展

1. **更多AI支持**: 易于添加新的AI编辑器支持
2. **模板系统**: 支持更复杂的命令模板和变量
3. **工作流集成**: 与IDE工作流更深度集成
4. **性能优化**: 进一步优化执行性能和用户体验

---

通过这次重构，我们实现了从复杂到简单的转变，同时保持了系统的强大功能和可扩展性。新的设计更加直观易用，同时为未来的功能扩展奠定了良好的基础。